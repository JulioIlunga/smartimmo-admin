{% extends 'base.html.twig' %}
{% block title %}Smart-Immo | Messengers{% endblock %}

{% block style %}
    <link href="{{ asset('assets/admin/css/dasboard.css') }}" rel="stylesheet">
    <style>
        :root{
            --brand:#dc3545;         /* base red */
            --brand-600:#b02a37;
            --ink:#1f2937;
            --muted:#6b7280;
            --line:#eef2f7;
        }
        .account-sidebar{
            position: sticky; top: 1.25rem;
            border:1px solid rgba(2,6,23,.06); border-radius:1rem; overflow:hidden;
            box-shadow:0 14px 36px rgba(220,53,69,.08); background:#fff;
        }
        .account-cover{
            height:96px;
            background:linear-gradient(135deg, rgba(220,53,69,.15), rgba(220,53,69,.05));
        }
        .account-profile{
            margin-top:-42px; text-align:center; padding:0 1.25rem 1.25rem;
        }
        .account-avatar{
            width:84px;height:84px;border-radius:50%;overflow:hidden;
            box-shadow:0 8px 24px rgba(0,0,0,.12); border:3px solid #fff; background:#f8fafc;
        }
        .account-name{color:var(--ink)}
        .account-phone{color:var(--muted)}
        .menu-label{
            font-size:.75rem; letter-spacing:.04em; text-transform:uppercase;
            color:var(--muted); margin: .25rem 1.25rem .5rem;
        }
        .side-nav{list-style:none; padding:.25rem  .75rem 1rem; margin:0;}
        .side-link{
            display:flex; align-items:center; gap:.5rem;
            padding:.65rem .85rem; margin:.25rem 0; border-radius:.8rem;
            color:var(--muted); text-decoration:none; border:1px solid transparent;
            transition:background .18s ease, border-color .18s ease, color .18s ease, transform .18s ease;
        }
        .side-link i, .side-link .mdi{font-size:1.05rem}
        .side-link:hover{ background:#fff; border-color:var(--line); color:var(--ink); transform:translateY(-1px)}
        .side-link.is-active{
            background:linear-gradient(180deg, rgba(220,53,69,.10), rgba(220,53,69,.06));
            border-color:rgba(220,53,69,.25); color:var(--brand-600);
        }
        .btn-dashboard{
            background:var(--brand); color:#fff; border:none; padding:.6rem 1rem;
            border-radius:999px; font-weight:600;
        }
        .btn-dashboard:hover{background:var(--brand-600); color:#fff}
    </style>
    <style>
        /* ===== Chat Layout ===== */
        .chat-shell { min-height: 72vh; background: #fff; }
        .chat-left   { min-height: 72vh; }
        .chat-right  { min-height: 72vh; }

        /* Header */
        .chat-header{
            position: sticky; top: 0; z-index: 5;
            padding: .9rem 1rem;
            border-bottom: 1px solid #eef1f4;
            background: #fff;
        }

        /* Messages area */
        .chat-messages{
            flex: 1 1 auto;
            overflow: auto;
            padding: 1rem 1rem 0;
            background: #f8f9fb;
        }

        /* Composer */
        .chat-composer{
            border-top: 1px solid #eef1f4;
            background: #fff;
            padding: .6rem .8rem;
        }
        .chat-composer .form-control{
            background: #f3f4f6;
            border-radius: .8rem;
            padding: .65rem .9rem;
        }
        .chat-composer .form-control:focus{ box-shadow: none; background: #eef0f3; }

        /* Buttons */
        .btn-icon{
            width: 40px; height: 40px; display: inline-flex;
            align-items: center; justify-content: center;
            border-radius: .8rem;
            padding: 0;
        }

        /* Avatars / images */
        .user-img{ width: 40px; height: 40px; object-fit: cover; }

        /* Optional: message bubbles if your stream uses .msg / .me */
        .messages .msg{ margin-bottom: .65rem; display: flex; }
        .messages .msg.me{ justify-content: flex-end; }
        .messages .msg .bubble{
            max-width: 80%;
            padding: .55rem .7rem;
            border-radius: .9rem;
            background: #fff;
            border: 1px solid #eef1f4;
            box-shadow: 0 3px 10px rgba(16,18,22,.05);
        }
        .messages .msg.me .bubble{
            background: rgba(220,53,69,.08);
            border-color: rgba(220,53,69,.25);
        }
        .messages .time{
            font-size: .75rem; color: #9aa3ad; margin-top: .2rem;
        }

        /* Right pane tweaks */
        .chat-right .rounded-3 { border-radius: 1rem !important; }

        /* Mobile */
        @media (max-width: 991.98px){
            .chat-shell{ border-radius: 1rem; }
            .chat-right{ border-left: 0 !important;

    </style>

{% endblock %}
{% block bodyClass %}
    class= 'bg-light header-top-br'
{% endblock %}
{% block body %}

    <div class="py-5 container">
        {% include 'agent_work_space/partials/_flag.html.twig' %}

        <div class="row position-relative align-items-start">
            <!-- Navbar -->
            <div class="col-lg-3 profile-sidebar-osahan">
                <aside class="account-sidebar" aria-label="Menu du compte">
                    <!-- Cover -->
                    <div class="account-cover"></div>

                    <!-- Profile -->
                    <div class="account-profile">
                        <div class="d-flex flex-column align-items-center">
                            <div class="account-avatar mb-2">
                                {% if user.picture == null %}
                                    <img src="{{ asset('assets/img/imageIcon.png') }}" class="w-100 h-100" style="object-fit:cover" alt="Photo de profil">
                                {% else %}
                                    <img src="{{ user.picture}}" class="w-100 h-100" style="object-fit:cover" alt="Photo de profil">
                                {% endif %}
                            </div>
                            <h5 class="mb-0 fw-bold account-name">{{ user.firstname }} {{ user.name }}</h5>
                            <small class="account-phone">{{ user.phonecode }} {{ user.phone }}</small>
                        </div>

                        {% set roles = app.user.roles %}
                        {% if roles|length == 3 and 'ROLE_AGENT' in roles and 'ROLE_CUSTOMER' in roles %}
                            <div class="listing text-center col-md-12 py-2">
                                <a href="{{ path('app_agent_work_space') }}" class="btn btn-dashboard rounded-9">Espace agent</a>
                            </div>
                        {% else %}
                            <div class="listing text-center col-md-12 py-2">
                                <a href="{{ path('app_account_switch', { id: user.id}) }}" class="btn btn-dashboard rounded-9">Passer à un compte agent</a>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Menu -->
                    <p class="menu-label">Menu principal</p>
                    <ul class="side-nav">
                        <li>
                            <a class="side-link {% if show == 'favoris' %}is-active{% endif %}"
                               {% if show == 'favoris' %}aria-current="page"{% endif %}
                               href="{{ path('account.toggle.view', {show: 'favoris'}) }}">
                                <span class="mdi mdi-chart-box-outline"></span> Mes favoris
                            </a>
                        </li>
                        <li>
                            <a class="side-link is-active"
                               {% if show == 'messenger' %}aria-current="page"{% endif %}
                               href="{{ path('account.toggle.view', {show: 'conversation'}) }}">
                                <span class="mdi mdi-chat"></span> Mes conversations
                            </a>
                        </li>
                        <li>
                            <a class="side-link {% if show == 'reservations' %}is-active{% endif %}"
                               {% if show == 'reservations' %}aria-current="page"{% endif %}
                               href="{{ path('account.toggle.view', {show: 'reservations'}) }}">
                                <span class="mdi mdi-calendar-check"></span> Mes réservations
                            </a>
                        </li>
                        <li>
                            <a class="side-link {% if show == 'profil' %}is-active{% endif %}"
                               {% if show == 'profil' %}aria-current="page"{% endif %}
                               href="{{ path('account.toggle.view', {show: 'profil'}) }}">
                                <span class="mdi mdi-card-account-phone-outline"></span> Mon profil
                            </a>
                        </li>
                        <li>
                            <a class="side-link" href="{{ path('app_logout') }}">
                                <span class="mdi mdi-logout"></span> Se déconnecter
                            </a>
                        </li>
                    </ul>
                </aside>
            </div>
            <!-- Content -->
            <div class="col-lg-9 ps-xl-5">
                <div class="dashboard-content">
                    <div class="row g-0 chat-shell rounded-4 border shadow-sm overflow-hidden">

                        <!-- Left: Chat panel -->
                        <div class="col-md-8 bg-white d-flex flex-column chat-left">

                            <!-- Header -->
                            <div class="chat-header d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center gap-2">
                                    <a href="{{ path('app_messenger') }}" class="btn btn-light btn-icon" title="Retour">
                                        <i class="mdi mdi-arrow-left"></i>
                                    </a>
                                    <h6 class="mb-0 fw-bold">
                                        {% if messenger.agent.id == user.id %}
                                            {{ messenger.client.firstname }} {{ messenger.client.name }}
                                        {% else %}
                                            {{ messenger.agent.firstname }} {{ messenger.agent.name }}
                                        {% endif %}
                                    </h6>
                                </div>

                                <button type="button" class="btn btn-danger btn-icon text-white" title="Rafraîchir"
                                        onclick="window.location.reload()">
                                    <i class="mdi mdi-reload mdi-spin"></i>
                                </button>
                            </div>

                            <!-- Messages -->
                            <div id="messages-table" class="chat-messages">
                                {# Your stream renders here #}
                                {% include 'messenger/message_stream.html.twig' %}
                            </div>

                            <!-- Composer -->
                            <div class="chat-composer">
                                <form id="chat-form" class="d-flex align-items-center gap-2" onsubmit="return doSend()">
                                    <input type="hidden" name="whoSendId" value="{{ app.user.id }}">
                                    <input type="hidden" name="messengerId" value="{{ messenger.id }}">

                                    <input type="text" class="form-control border-0"
                                           name="message" autocomplete="off"
                                           placeholder="Tapez votre message…">
                                    <button class="btn btn-dark btn-icon" aria-label="Envoyer">
                                        <i class="mdi mdi-send"></i>
                                    </button>
                                </form>
                            </div>
                        </div>

                        <!-- Right: Property / Info -->
                        <div class="col-md-4 bg-white border-start p-4 chat-right">
                            <img src="{{ messenger.property.image }}" class="img-fluid rounded-3 mb-3" alt="Illustration">

                            <h6 class="mb-1 fw-bold">{{ messenger.property.type }}</h6>
                            <div class="d-flex flex-wrap gap-2 mb-1">
                                {% if messenger.property.commune.name %}
                                    <span class="badge-chip"><i class="mdi mdi-map-marker-outline me-1"></i>{{ messenger.property.commune.name }}</span>
                                {% endif %}
                                {% if messenger.property.typeLocation %}
                                    <span class="badge-chip"><i class="mdi mdi-home-outline me-1"></i>{{ messenger.property.typeLocation }}</span>
                                {% endif %}
                            </div>

                            <div class="d-flex align-items-center justify-content-between small text-muted mb-3">
                                <span>Date de publication</span>
                                <span>{{ messenger.property.createdAt|date('d M Y') }}</span>
                            </div>

                            <div class="border-top border-bottom py-3 my-3 d-flex align-items-center justify-content-between">
                                <span class="mb-0 fw-bold">Prix</span>
                                <span class="mb-0 fw-bold">{{ messenger.property.currency }} {{ messenger.property.price }}</span>
                            </div>

                            <div class="mt-3">
                                <h6 class="fw-bold mb-3">Annonceur</h6>
                                <div class="d-flex align-items-center">
                                    {% set pp = messenger.property.user.picture ?? asset('assets/img/imageIcon.png') %}
                                    <img src="{{ pp }}" class="user-img rounded-3 me-2" alt="Annonceur">
                                    <small class="text-muted">{{ messenger.property.user.firstname }}</small>
                                </div>
                            </div>

                            <div class="pt-4 mt-4 border-top">
                                <p class="mb-3">
                                    <a href="#" class="text-muted d-inline-flex align-items-center fw-semibold small">
                                        <i class="mdi mdi-progress-question me-2 fs-5"></i> Aide
                                    </a>
                                </p>
                                <a href="#" class="text-muted d-inline-flex align-items-center fw-semibold small">
                                    <i class="mdi mdi-flag me-2 fs-5"></i> Reporter l’agent
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

            </div>


        </div>
    </div>
    <!-- Jquery js -->
    <script src="{{ asset('assets/vendor/jquery/jquery.min.js') }}"></script>
    <!-- Bootstrap Bundle -->
    <script src="{{ asset('assets/vendor/bootstrap/dist/js/bootstrap.bundle.min.js') }}"></script>
    <!-- slick Slider JS-->
    <script type="text/javascript" src="{{ asset('assets/vendor/slick/slick.min.js') }}"></script>
    <!-- Date Picker -->
    <script src="{{ asset('assets/vendor/date-picker/date-picker.js') }}"></script>
    <!-- Custom scripts for all pages-->
    <script src="{{ asset('assets/js/osahan.js') }}"></script>

    <script>
        function doSend() {
            const url = "{{ path('app_messenger_chat_save') }}";
            const content = '<div class="text-center"> <div class="spinner-border text-danger m-1" style="width: 3rem; height: 3rem;" role="status"> <span class="visually-hidden">Loading...</span> </div>';
            $.ajax({
                url: url,
                type: "post",
                data: $("#chat-form").serialize(),
                beforeSend: function () {
                    $("#messages-table").html(content);
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    alert(xhr.status);
                },
                success: function (data) {
                    $("#messages-table").html(data);
                    window.location.reload();
                }
            });
            return false;
        }
    </script>
{% endblock %}

